name: Deploy Website

on:
  push:
    branches: [ main, dev ]

permissions:
  id-token: write   # Required for requesting the JWT from GitHub
  contents: read    # Required for actions/checkout to read your code

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Debug Environment Info
        run: |
          echo "Branch: ${{ github.ref_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Ref: ${{ github.ref }}"

      - name: Set environment variables
        id: set-env
        run: |
          if [ "${{ github.ref_name }}" == "main" ]; then
            echo "env_name=prod" >> $GITHUB_OUTPUT
            echo "role_arn=${{ secrets.AWS_ROLE_ARN_PROD }}" >> $GITHUB_OUTPUT
            echo "bucket_name=${{ secrets.BUCKET_NAME_PROD }}" >> $GITHUB_OUTPUT
          else
            echo "env_name=dev" >> $GITHUB_OUTPUT
            echo "role_arn=${{ secrets.AWS_ROLE_ARN_DEV }}" >> $GITHUB_OUTPUT
            echo "bucket_name=${{ secrets.BUCKET_NAME_DEV }}" >> $GITHUB_OUTPUT
          fi

      - name: Display deployment target
        run: |
          echo "Deploying to: ${{ steps.set-env.outputs.env_name }}"
          echo "Bucket: ${{ steps.set-env.outputs.bucket_name }}"

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4.0.2
        timeout-minutes: 2
        with:
          role-to-assume: ${{ steps.set-env.outputs.role_arn }}
          aws-region: ap-south-1
          role-session-name: GitHubActionsS3Deploy
          role-duration-seconds: 900

      - name: Verify AWS Identity
        run: |
          echo "âœ… Successfully assumed role!"
          aws sts get-caller-identity

      - name: Deploy index.html to S3
        run: |
          echo "ğŸ“¦ Deploying to bucket: ${{ steps.set-env.outputs.bucket_name }}"
          aws s3 sync . s3://${{ steps.set-env.outputs.bucket_name }} --exclude "*" --include "index.html" --delete
          echo "âœ… Files synced successfully"

      - name: Print Website URL
        run: |
          echo "=========================================="
          echo "âœ… Deployment successful!"
          echo "ğŸŒ Website URL: http://${{ steps.set-env.outputs.bucket_name }}.s3-website-ap-south-1.amazonaws.com"
          echo "ğŸ“ Environment: ${{ steps.set-env.outputs.env_name }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "=========================================="
